<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日程調整テキスト生成ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">日程調整テキスト生成ツール</h1>
            <p class="text-gray-600 mt-2">Googleカレンダーと連携して、候補日程を簡単にリストアップします。</p>
        </header>

        <!-- Authentication Section -->
        <div id="auth-section" class="text-center mb-8 p-6 bg-white rounded-xl shadow-md">
            <p id="auth-message" class="text-lg mb-4">ステップ1: Googleアカウントでログインしてください。</p>
            <button id="authorize_button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center mx-auto disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.089,5.571l6.19,5.238C42.012,35.846,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Googleでログイン
            </button>
            <div id="user-info" class="hidden mt-4">
                <p class="text-green-600 font-semibold">ログイン成功！</p>
                <p id="user-email" class="text-gray-700"></p>
                <button id="signout_button" class="mt-2 text-sm text-blue-500 hover:underline">ログアウト</button>
            </div>
        </div>

        <main id="main-content" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Settings Panel -->
            <div class="bg-white p-6 rounded-xl shadow-md h-full flex flex-col">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">ステップ2: 条件を設定</h2>
                <div class="flex-grow">
                    <!-- Calendar Selection -->
                    <div class="mb-4">
                        <label class="block text-lg font-semibold text-gray-700 mb-2">1. 空き時間を調べるカレンダー</label>
                        <div id="calendar-list" class="space-y-1 max-h-60 overflow-y-auto border rounded-lg p-3 bg-gray-50 mb-2">
                            <p class="text-gray-500">カレンダーを読み込んでいます...</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">※チェックを入れたメンバー・リソースの空き時間を検索します。</p>
                    </div>

                    <!-- Date Range -->
                    <div class="mb-4">
                        <label class="block text-lg font-semibold text-gray-700 mb-2">2. 期間</label>
                        <div class="flex items-center space-x-2">
                            <input type="date" id="start-date" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">〜</span>
                            <input type="date" id="end-date" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Time Window -->
                    <div class="mb-4">
                        <label class="block text-lg font-semibold text-gray-700 mb-2">3. 時間帯</label>
                         <div class="flex items-center space-x-2">
                            <input type="time" id="start-time" value="10:00" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">〜</span>
                            <input type="time" id="end-time" value="19:00" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Meeting Duration -->
                    <div class="mb-4">
                        <label for="duration" class="block text-lg font-semibold text-gray-700 mb-2">4. 所要時間（分）</label>
                        <input type="number" id="duration" value="60" min="30" step="30" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Exclude Time Window -->
                    <div class="mb-4">
                        <div class="flex items-center mb-2">
                             <input type="checkbox" id="exclude-time-checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <label for="exclude-time-checkbox" class="ml-3 block text-lg font-semibold text-gray-700">5. 除外する時間帯（毎日）</label>
                        </div>
                        <div id="exclude-time-inputs" class="flex items-center space-x-2 transition-opacity duration-300">
                            <input type="time" id="exclude-start-time" value="12:00" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">〜</span>
                            <input type="time" id="exclude-end-time" value="13:00" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <!-- Exclude Weekends and Holidays -->
                    <div class="mb-4">
                        <div class="flex items-center">
                             <input type="checkbox" id="exclude-holidays-checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <label for="exclude-holidays-checkbox" class="ml-3 block text-lg font-semibold text-gray-700">6. 土日・祝日を除外する</label>
                        </div>
                    </div>
                </div>
                <!-- Generate Button -->
                <div class="text-center mt-auto pt-4">
                    <button id="generate-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path></svg>
                        候補日程を生成
                    </button>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="bg-white p-6 rounded-xl shadow-md h-full flex flex-col">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">ステップ3: テキストをコピー</h2>
                <div id="loading-spinner" class="hidden flex-grow flex justify-center items-center">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
                </div>
                <div id="result-area" class="flex-grow flex flex-col">
                    <textarea id="output" rows="22" class="w-full p-3 border rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 flex-grow" placeholder="ここに候補日程が出力されます。"></textarea>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <button id="copy-button" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center whitespace-nowrap">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            テキストをコピー
                        </button>
                         <a href="https://calendar.google.com/" target="_blank" rel="noopener noreferrer" id="open-calendar-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center whitespace-nowrap">
                             <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            自分のカレンダー
                        </a>
                    </div>
                    <p id="copy-feedback" class="text-center text-green-500 mt-2 h-5"></p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ▼▼▼▼▼ GitHub Actionsで自動置換されるプレースホルダー ▼▼▼▼▼
        const CLIENT_ID = '__CLIENT_ID__'; 
        const API_KEY = '__API_KEY__';     
        // ▲▲▲▲▲ ここまで ▲▲▲▲▲

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
        const TOKEN_STORAGE_KEY = 'google_calendar_api_token';

        // 常時表示するカレンダーリスト定義
        const FIXED_CALENDARS = [
            { id: 'yusuke@lct.jp', summary: '山口' },
            { id: 'takaaki@lct.jp', summary: '伊野' },
            { id: 'syushi@lct.jp', summary: '山田' },
            { id: 'masakazu@lct.jp', summary: '松延' },
            { id: 'yoshihisa@lct.jp', summary: '赤窄' },
            { id: 'gentaro@lct.jp', summary: '中村' },
            { id: 'yohei@lct.jp', summary: '橋本' },
            { id: 'hiroshi@lct.jp', summary: '徳田' },
            { id: 'shouta@lct.jp', summary: '福田' },
            { id: 'yuji@lct.jp', summary: '野元' },
            { id: 'mio@lct.jp', summary: '有馬' },
            { id: 'asuka@lct.jp', summary: '児玉' },
            { id: 'akinari@lct.jp', summary: '福中' },
            { id: 'tomoyo@lct.jp', summary: '青木' },
            { id: 'c_188d7852eutsah39lq12av59269n4@resource.calendar.google.com', summary: '会議室' },
            { id: 'c_1880j0tbasftagpklob5996r8cn62@resource.calendar.google.com', summary: '集中ブース' },
            { id: 'c_18825utfj6eaaioqm6j5e0e9bmh60@resource.calendar.google.com', summary: 'ZOOM' },
            { id: 'c_188a22pfeu3rchraliusad9677pro@resource.calendar.google.com', summary: '社用車' }
        ];

        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const generateButton = document.getElementById('generate-button');
        const copyButton = document.getElementById('copy-button');
        const excludeTimeCheckbox = document.getElementById('exclude-time-checkbox');
        const excludeTimeInputs = document.getElementById('exclude-time-inputs');
        const excludeHolidaysCheckbox = document.getElementById('exclude-holidays-checkbox');
        
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let currentUserEmail = '';

        // --- Initialization ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            attemptAutoLogin(); 
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthResponse,
            });
            gisInited = true;
            attemptAutoLogin(); 
        }

        function attemptAutoLogin() {
            if (gapiInited && gisInited) {
                // 1. Try to restore token from storage
                const storedToken = loadTokenFromStorage();
                if (storedToken) {
                    gapi.client.setToken(storedToken);
                    updateSigninStatus(true);
                    authorizeButton.disabled = false;
                    return;
                }

                // 2. If no valid token, try silent login
                tokenClient.requestAccessToken({prompt: 'none'});
                authorizeButton.disabled = false;
            }
        }

        // --- Authentication ---
        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function handleAuthResponse(resp) {
            if (resp.error !== undefined && resp.error !== 'popup_closed_by_user') {
                console.log('Login required or error:', resp.error);
                // Don't updateSigninStatus(false) here to keep the button visible
                return;
            }
            
            // Save token
            saveTokenToStorage(resp);
            
            await updateSigninStatus(true);
        }

        // --- Token Storage Helper ---
        function saveTokenToStorage(tokenResponse) {
            const now = new Date().getTime();
            // expiresIn is in seconds. Expire 5 mins early to be safe.
            const expiry = now + (tokenResponse.expires_in - 300) * 1000;
            const data = {
                token: tokenResponse,
                expiry: expiry
            };
            localStorage.setItem(TOKEN_STORAGE_KEY, JSON.stringify(data));
        }

        function loadTokenFromStorage() {
            const json = localStorage.getItem(TOKEN_STORAGE_KEY);
            if (!json) return null;
            
            try {
                const data = JSON.parse(json);
                const now = new Date().getTime();
                
                if (now < data.expiry) {
                    return data.token;
                } else {
                    localStorage.removeItem(TOKEN_STORAGE_KEY);
                    return null;
                }
            } catch (e) {
                return null;
            }
        }

        authorizeButton.onclick = handleAuthClick;

        signoutButton.onclick = async () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    localStorage.removeItem(TOKEN_STORAGE_KEY); // Clear storage
                    updateSigninStatus(false);
                });
            }
        };

        async function updateSigninStatus(isSignedIn) {
            const authSection = document.getElementById('auth-section');
            const mainContent = document.getElementById('main-content');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            
            if (isSignedIn) {
                authSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                
                try {
                    // Try to get email if not already set (might fail if scope issues, but cal ID usually works)
                    const primaryCal = await gapi.client.calendar.calendars.get({calendarId: 'primary'});
                    currentUserEmail = primaryCal.result.id;
                    userEmail.textContent = `ログイン中: ${currentUserEmail}`;
                } catch (err) {
                     console.error("Error fetching profile", err);
                     // If token is invalid, clear it and reset
                     if (err.status === 401) {
                        localStorage.removeItem(TOKEN_STORAGE_KEY);
                        updateSigninStatus(false);
                        return;
                     }
                     userEmail.textContent = 'ユーザー情報の取得に失敗';
                }

                listCalendars();
                setDefaultDates();
            } else {
                authSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
                currentUserEmail = '';
            }
        }

        // --- Calendar Logic ---
        
        function renderCalendarItem(container, id, summary, isChecked) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-1 hover:bg-gray-100 rounded';

            const leftDiv = document.createElement('div');
            leftDiv.className = 'flex items-center overflow-hidden flex-grow';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = id;
            checkbox.value = id;
            checkbox.className = 'h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 flex-shrink-0';
            checkbox.checked = isChecked;

            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = summary || id;
            label.className = 'ml-3 block text-sm font-medium text-gray-700 truncate cursor-pointer select-none w-full';
            label.title = summary || id;

            leftDiv.appendChild(checkbox);
            leftDiv.appendChild(label);
            div.appendChild(leftDiv);
            container.appendChild(div);
        }

        function listCalendars() {
            const calendarListEl = document.getElementById('calendar-list');
            calendarListEl.innerHTML = '';

            FIXED_CALENDARS.forEach(cal => {
                const isMyCalendar = (cal.id === currentUserEmail);
                renderCalendarItem(calendarListEl, cal.id, cal.summary, isMyCalendar);
            });
        }
        
        function setDefaultDates() {
            const today = new Date();
            const twoWeeksLater = new Date();
            twoWeeksLater.setDate(today.getDate() + 14);

            document.getElementById('start-date').valueAsDate = today;
            document.getElementById('end-date').valueAsDate = twoWeeksLater;
        }

        generateButton.onclick = async () => {
            const outputEl = document.getElementById('output');
            const loadingSpinner = document.getElementById('loading-spinner');
            const resultArea = document.getElementById('result-area');

            outputEl.value = '';
            loadingSpinner.classList.remove('hidden');
            resultArea.classList.add('hidden');

            try {
                const selectedCalendars = Array.from(document.querySelectorAll('#calendar-list input:checked')).map(cb => ({ id: cb.value }));
                if (selectedCalendars.length === 0) {
                    throw new Error("確認するカレンダーを1つ以上選択してください。");
                }

                const startDateStr = document.getElementById('start-date').value;
                const endDateStr = document.getElementById('end-date').value;
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                const duration = parseInt(document.getElementById('duration').value, 10);
                
                if (!startDateStr || !endDateStr || !startTime || !endTime || !duration) {
                    throw new Error("すべての日時と所要時間を入力してください。");
                }

                const timeMin = new Date(`${startDateStr}T00:00:00`).toISOString();
                const timeMax = new Date(`${endDateStr}T23:59:59`).toISOString();
                
                const busyTimes = [];
                
                const freeBusyResponse = await gapi.client.calendar.freebusy.query({
                    timeMin,
                    timeMax,
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    items: selectedCalendars,
                });
                Object.values(freeBusyResponse.result.calendars).forEach(cal => {
                    cal.busy.forEach(b => {
                        busyTimes.push({ start: new Date(b.start), end: new Date(b.end) });
                    });
                });

                if (excludeTimeCheckbox.checked) {
                    const excludeStartTimeStr = document.getElementById('exclude-start-time').value;
                    const excludeEndTimeStr = document.getElementById('exclude-end-time').value;
                    if (excludeStartTimeStr && excludeEndTimeStr) {
                        const [excludeStartHour, excludeStartMinute] = excludeStartTimeStr.split(':').map(Number);
                        const [excludeEndHour, excludeEndMinute] = excludeEndTimeStr.split(':').map(Number);
                        let loopDay = new Date(startDateStr);
                        const endDay = new Date(endDateStr);
                        while (loopDay <= endDay) {
                            const excludeStart = new Date(loopDay);
                            excludeStart.setHours(excludeStartHour, excludeStartMinute, 0, 0);
                            const excludeEnd = new Date(loopDay);
                            excludeEnd.setHours(excludeEndHour, excludeEndMinute, 0, 0);
                            if (excludeEnd > excludeStart) {
                                busyTimes.push({ start: excludeStart, end: excludeEnd });
                            }
                            loopDay.setDate(loopDay.getDate() + 1);
                        }
                    }
                }

                const holidaySet = new Set();
                if (excludeHolidaysCheckbox.checked) {
                    const holidayCalendarId = 'ja.japanese#holiday@group.v.calendar.google.com';
                    const holidayResponse = await gapi.client.calendar.events.list({
                        calendarId: holidayCalendarId,
                        timeMin: timeMin,
                        timeMax: timeMax,
                        singleEvents: true,
                    });
                    const holidays = holidayResponse.result.items;
                    if (holidays && holidays.length > 0) {
                        holidays.forEach(holiday => {
                            holidaySet.add(holiday.start.date);
                        });
                    }
                }
                
                busyTimes.sort((a, b) => a.start - b.start);
                const mergedBusyTimes = [];
                if (busyTimes.length > 0) {
                    let currentBusy = { ...busyTimes[0] };
                    for (let i = 1; i < busyTimes.length; i++) {
                        const nextBusy = busyTimes[i];
                        if (nextBusy.start < currentBusy.end) {
                            currentBusy.end = new Date(Math.max(currentBusy.end, nextBusy.end));
                        } else {
                            mergedBusyTimes.push(currentBusy);
                            currentBusy = { ...nextBusy };
                        }
                    }
                    mergedBusyTimes.push(currentBusy);
                }

                const availableSlots = findAvailableSlots(
                    new Date(startDateStr), 
                    new Date(endDateStr), 
                    startTime, 
                    endTime, 
                    duration, 
                    mergedBusyTimes,
                    holidaySet
                );
                
                outputEl.value = formatAvailableSlots(availableSlots, duration);

            } catch (err) {
                outputEl.value = `エラーが発生しました: ${err.message}`;
                console.error(err);
            } finally {
                loadingSpinner.classList.add('hidden');
                resultArea.classList.remove('hidden');
            }
        };

        function findAvailableSlots(startDate, endDate, startTimeStr, endTimeStr, durationMinutes, busyTimes, holidaySet) {
            const availableSlots = [];
            const [startHour, startMinute] = startTimeStr.split(':').map(Number);
            const [endHour, endMinute] = endTimeStr.split(':').map(Number);

            let currentDay = new Date(startDate);
            currentDay.setHours(0, 0, 0, 0);

            while (currentDay <= endDate) {
                const dateString = `${currentDay.getFullYear()}-${(currentDay.getMonth() + 1).toString().padStart(2, '0')}-${currentDay.getDate().toString().padStart(2, '0')}`;
                if (excludeHolidaysCheckbox.checked) {
                    const dayOfWeek = currentDay.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6 || holidaySet.has(dateString)) {
                        currentDay.setDate(currentDay.getDate() + 1);
                        continue;
                    }
                }

                const daySlots = [];
                const searchStart = new Date(currentDay);
                searchStart.setHours(startHour, startMinute, 0, 0);

                const searchEnd = new Date(currentDay);
                searchEnd.setHours(endHour, endMinute, 0, 0);

                let slotStart = new Date(searchStart);

                while (slotStart < searchEnd) {
                    const slotEnd = new Date(slotStart.getTime() + durationMinutes * 60 * 1000);

                    if (slotEnd > searchEnd) {
                        break;
                    }

                    let isAvailable = true;
                    for (const busy of busyTimes) {
                        if (slotStart < busy.end && slotEnd > busy.start) {
                            isAvailable = false;
                            slotStart = new Date(busy.end);
                            const minutes = slotStart.getMinutes();
                            if (minutes > 0 && minutes <= 30) slotStart.setMinutes(30, 0, 0);
                            else if (minutes > 30) {
                                slotStart.setHours(slotStart.getHours() + 1, 0, 0, 0);
                            }
                            break;
                        }
                    }

                    if (isAvailable) {
                        daySlots.push(new Date(slotStart));
                        slotStart.setMinutes(slotStart.getMinutes() + 30);
                    }
                }
                
                if (daySlots.length > 0) {
                    availableSlots.push({ date: new Date(currentDay), slots: daySlots });
                }

                currentDay.setDate(currentDay.getDate() + 1);
            }
            return availableSlots;
        }

        function formatAvailableSlots(availableSlots, durationMinutes) {
            if (availableSlots.length === 0) {
                return "指定された条件での空き時間が見つかりませんでした。";
            }

            const weekdays = ['(日)', '(月)', '(火)', '(水)', '(木)', '(金)', '(土)'];
            let text = "下記日時でご都合いかがでしょうか？\n\n";

            availableSlots.forEach(dayData => {
                const date = dayData.date;
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = weekdays[date.getDay()];
                text += `${month}月${day}日${weekday}\n`;

                const slots = dayData.slots;
                if (slots.length === 0) return;

                let i = 0;
                while (i < slots.length) {
                    let j = i;
                    while (j + 1 < slots.length &&
                           (slots[j+1].getTime() - slots[j].getTime()) === 30 * 60 * 1000) {
                        j++;
                    }

                    const startSlot = slots[i];
                    const endSlot = slots[j];

                    const startHour = startSlot.getHours().toString().padStart(2, '0');
                    const startMinute = startSlot.getMinutes().toString().padStart(2, '0');
                    
                    const finalEndTime = new Date(endSlot.getTime() + durationMinutes * 60 * 1000);
                    const endHour = finalEndTime.getHours().toString().padStart(2, '0');
                    const endMinute = finalEndTime.getMinutes().toString().padStart(2, '0');

                    text += `・${startHour}:${startMinute}〜${endHour}:${endMinute}\n`;
                    
                    i = j + 1;
                }
                text += "\n";
            });
            
            text += "ご確認、よろしくお願いいたします。";
            return text;
        }

        // --- UI Helpers ---
        excludeTimeCheckbox.addEventListener('change', () => {
            const inputs = excludeTimeInputs.querySelectorAll('input');
            if (excludeTimeCheckbox.checked) {
                excludeTimeInputs.style.opacity = '1';
                inputs.forEach(input => input.disabled = false);
            } else {
                excludeTimeInputs.style.opacity = '0.5';
                inputs.forEach(input => input.disabled = true);
            }
        });

        copyButton.onclick = () => {
            const output = document.getElementById('output');
            output.select();
            try {
                document.execCommand('copy');
                const feedback = document.getElementById('copy-feedback');
                feedback.textContent = 'コピーしました！';
                setTimeout(() => { feedback.textContent = ''; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                const feedback = document.getElementById('copy-feedback');
                feedback.textContent = 'コピーに失敗しました。';
                 setTimeout(() => { feedback.textContent = ''; }, 2000);
            }
        };

        const scriptGis = document.createElement('script');
        scriptGis.src = 'https://accounts.google.com/gsi/client';
        scriptGis.async = true;
        scriptGis.defer = true;
        scriptGis.onload = gisLoaded;
        document.body.appendChild(scriptGis);

        const scriptGapi = document.createElement('script');
        scriptGapi.src = 'https://apis.google.com/js/api.js';
        scriptGapi.async = true;
        scriptGapi.defer = true;
        scriptGapi.onload = gapiLoaded;
        document.body.appendChild(scriptGapi);

    </script>
</body>
</html>
```eof
